ADR-001: Wordle tipo žaidimas (React + Vite + Tailwind)

ID: ADR-001
Data: 2025-09-03
Sprendimo būsena: Patvirtinta
Autorius: Simonas

Tikslas

Sukurti Wordle tipo žaidimą lietuviškai su aiškiomis taisyklėmis, informatyviais klaidų pranešimais ir geru testų padengimu. MVP orientuotas į vieno žaidėjo patirtį naršyklėje.

Kontekstas

Naudojamos technologijos: React, Vite, Tailwind CSS, TypeScript, Vitest, (Playwright – planuojama).

Reikia UI su taisyklių paaiškinimu (modalas) ir informatyviais klaidų pranešimais (LT).

MVP: su lietuviškomis raidėmis (ą, č, ę, ė, į, š, ų, ū, ž); žodžių sąrašas 100 įrašų (tiksliai 5 raidės).

Sprendimas (architektūra ir technologijos)

Framework: React 19+ (naujausia stabilioji)

Bundler: Vite

Stilius: Tailwind CSS

Kalba: TypeScript

Testai: Vitest (unit), @testing-library/react (integraciniai), Playwright (E2E)

Būsenos valdymas: React hook’ai (Context+reducer nereikalingas MVP)

Duomenys: localStorage (būsenos išsaugojimas, su versijavimu/migracija)

Žodynas:

- `solutions.json` – lygiai 100 lietuviškų 5 raidžių žodžių (galimi dienos tikslai)
- `allowed.json` – leidžiamų įvedimų sąrašas (⊇ solutions). Šiuo metu nustatytas toks pat kaip `solutions.json` (100/100) stabilumui.

MVP apimtis

5 raidžių žodis, 6 bandymai, tikslinis žodis parenkamas atsitiktinai kiekvienam naujam žaidimui

Lenta, klaviatūra (ekrano + fizinė). Ekraninė klaviatūra: 3 bazinės eilutės kaip anksčiau + atskira lietuviškų diakritikų eilutė.

Taisyklių modalas, LT klaidų pranešimai

LocalStorage išsaugojimas su schema versija

Prieinamumas (a11y): aria-live pranešimai, klaviatūros navigacija, spalvų alternatyvos

Unit + integraciniai testai

Domeno modelis

Tipai: Word, Guess, FeedbackCell, AttemptResult, GameState

Funkcijos: validateGuess, scoreGuess, isWin, pickDailyTarget (naudojama tik testams/regresijai), normalizeInput

GameState papildytas: epochDay, targetId, version (storage schema), wordlistVersion

Taisyklės (rodoma ir UI)

Atspėk 5 raidžių žodį per 6 bandymus.

Po bandymo: žalia (teisinga vieta), geltona (yra žodyje, kita vieta), pilka (nėra žodyje).

Leidžiami tik 5 raidžių žodžiai iš leidžiamo sąrašo (allowed.json).

Leidžiamos LT raidės su diakritikomis (įvestis išsaugoma nekeičiant diakritikų). Įvestis:
- Fizinis klaviatūros įvedimas – regex `^[a-ząčęėįšųūž]$` (didžiosios/mažosios) (`src/App.tsx`).
- Ekraninė klaviatūra – papildoma LT eilutė (`src/components/Keyboard.tsx`).

Klaidų pranešimai (pavyzdžiai)

„Žodis per trumpas (4/5). Įvesk 5 raidžių žodį.“

„Žodyne nėra: "xxxxx". Pasirink kitą 5 raidžių žodį.“

„Bandymų nebeliko. Teisingas žodis: XXXXX. Paspausk „Naujas žaidimas“.“

„Leidžiami tik raidiniai simboliai A–Ž.“

Tikslinio žodžio parinkimas

Numatytai parenkamas atsitiktinai kiekvienam naujam žaidimui.

Istorinis/deterministinis parinkimas pagal dieną (`pickDailyTarget`) paliekamas kode testams ir regresijai, bet UI naudoja atsitiktinį (`emptyState()` kviečia `pickRandomTarget()`).

`wordlistVersion` vis dar saugoma būsenos schemoje, kad ateityje keičiant žodyną būtų galima valdyti migracijas.

Papildomos funkcijos (artimiausias prioritetas)

1) Dalinimasis rezultatais

- UX: po pergalės/pralaimėjimo rodomas mygtukas „Kopijuoti rezultatą“. Formatas: 5x6 emoji tinklelis (🟩/🟨/⬛) be spoilerių + data/epochDay + nuoroda į žaidimą.
- Įgyvendinimas: util funkcija, kuri iš `attempts`/`feedback` suformuoja tekstą; `navigator.clipboard.writeText` su fallback.
- A11y: `aria-live` pranešimas „Nukopijuota į iškarpinę“.

3) ESC uždaro modalius

- UX/A11y: paspaudus Escape, turi užsidaryti atidarytas modalas (Rules/Stats ir pan.).
- Įgyvendinimas: `useEffect` su `keydown` listeneriu modaliuose; užtikrinti `aria-modal` ir focus grąžinimą.

4) Hard Mode

- UX: perjungiklis „Hard“ antraštėje. Įjungus – privaloma naudoti anksčiau atskleistas užuominas: žalios raidės turi likti tose pačiose pozicijose, geltonos – privalo būti žodyje; taip pat įsijungia per‑spėjimo laikmatis.
- Įgyvendinimas: prieš `validateGuess()` – papildomas patikrinimas pagal ankstesnius bandymus. Klaidos pranešimai LT. Laikmatis startuoja su pirmu įvedimu ir, jam pasibaigus, automatiškai prarandamas bandymas.

5) Konfeti/pergalių fejerverkai

- UX: laimėjus – trumpa konfeti animacija (2.5s), neveikia sąveikai (pointer-events none).
- Įgyvendinimas: `Confetti` `<canvas>` komponentas, kuris veikia renderinant > automatiškai išsijungia.

6) Mini kalendorius statistikoje

- UX: statistikos modale rodoma paskutinių ~30 dienų rezultatai kaip mažų kvadratėlių tinklelis (žalia/pralaimėta raudona/nežaista pilka).
- Įgyvendinimas: naudojamas `resultsByDay` iš `localStorage.stats`. Jei trūksta datų – vizualizuojamas artimiausias periodas pagal turimus raktus.

7) Apatinė veiksmų juosta (Rules/Stats) visose rezoliucijose

- UX: „📊 Statistika“ ir „📜 Taisyklės“ yra nuolat pasiekiami sticky apatinėje juostoje virš klaviatūros/apačios krašto, tiek mobiliuose, tiek desktop’uose. Antraštėje mygtukų nebėra (viršuje liko „Naujas žaidimas“ ir „⚡ Sunku“).
- Įgyvendinimas: juosta su `sticky bottom-0`, pusiau permatomu fonu (`bg-gray-900/70`), `backdrop-blur`, subtilus `border-t` ir `env(safe-area-inset-bottom)` padding. Eiliškumas: pirmiausia `📊 Statistika`, po to `📜 Taisyklės`.

Ikonų politika

- Principai: naudoti paprastas, semantiškas emoji piktogramas tekstui sustiprinti, bet ne pakeisti. Pvz.: `📊 Statistika`, `📜 Taisyklės`, `⚡ Sunku`.
- Prieinamumas: tekstas visada lieka; ikonų buvimas nekeičia reikšmės. Atributai `aria-pressed`, `aria-label` naudojami būsenoms.

Testavimo strategija

Struktūra: visi testai laikomi `src/__tests__/` (unit, component, integration) dėl stabilumo ir aiškumo.

Unit (Vitest): validateGuess, scoreGuess (dvigubos raidės), pickDailyTarget, normalizeInput, baseEpochDay; storage serijų logika ir guard’ai.

Component: Board (eilučių/plytelių atvaizdavimas, animacijų klasės), StatsModal (KPI, uždarymas su Escape/overlay).

Integraciniai (RTL): App – įvedimas per ekraninę klaviatūrą, klaidų pranešimai, laimėjimo srautas ir „geriausio laiko“ (best time) persistencija po „Naujas žaidimas“.

Aplinka: `vitest.setup.ts` pateikia `requestAnimationFrame` ir `HTMLCanvasElement.getContext` maketus; Confetti testuose – no-op mock, kad išvengtume jsdom canvas apribojimų.

Testavimo pastabos ir sprendimai
---------------------------------

- `StatsModal` komponentui pridėtas pasirenkamas `animationDuration` props (numatytai 700 ms).
- Determinizmui KPI testuose naudojame strategijas:
  - `animationDuration={0}` – reikšmės atnaujinamos iškart (be tarpinių kadrų).
  - RAF kelias (baigimas per pirmą kadrą) – `requestAnimationFrame` stub’inamas taip, kad pirmame kvietime perduotume didelį laiką ir animacija baigtųsi (p=1), leidžia patikrinti count-up be `useFakeTimers`.
  - RAF kelias (tęsinys) – papildomas testas, kuris pirmame kvietime perduoda `t=0` (p<1), todėl suplanuojamas antras kadras; antrame kvietime `t>duration` užbaigia animaciją (padengia p<1 šaką).
- Lokalizacijos tarpas tarp skaičiaus ir `%` (pvz., `75 %`) tikrinamas regex su pasirenkamu tarpu: `/75\s*%/`.
- `navigator.vibrate` jsdom’e nėra – testuose įdedamas stabilus stub’as: `Object.defineProperty(navigator, 'vibrate', { value: vi.fn(), configurable: true, writable: true })` ir tik tada spyOn.
- React 19 dev perspėjimas „Expected static flag was missing“ nutildomas `vitest.setup.ts` per `console.error` spy, paliekant kitus error’us.
- `StatsModal` KPI grid’as semantiškai apgaubtas `role="group" aria-label="KPI"`, kad testai galėtų siaurinti paiešką ir išvengti dviprasmybių.
- Mini kalendoriaus testas izoliuojamas: prieš importą resetinam modulius ir mockinam `loadStats()` su `resultsByDay` pagal `baseEpochDay()` (pvz., `{ [today]: 'win', [today-1]: 'loss' }`), kad visos būsenos tikrai patektų į matomą 5 savaičių langą.

Padengimas: 100% politika
-------------------------

- Globalūs slenksčiai `vitest.config.ts`: `lines:100`, `statements:100`, `functions:100`, `branches:100`.
- Hard Mode ir laikmačio testai: validacija (žalios/geltonos/raidžių kiekiai), laiko pabaigos srautas (prarastas bandymas), laikmačio nerodymas ir nestartavimas, kai Hard Mode išjungtas.
- Papildomi testai pridengia likusias šakas: `AnimatedNumber` momentinis kelias (`duration=0`), RAF tęsimo šaka (kai `p<1` suplanuojamas kitas kadras), ir bandymų pasiskirstymo juostų pločių skaičiavimas tiek kai `wins>0 && maxAttempts>0`, tiek fallback atveju.
- Histogramos pločio skaičiavimas supaprastintas pašalinant nepasiekiamą šaką: `maxAttempts` visada ≥1 (išvedamas su `Math.max(1, ...)`), todėl pakanka `Math.max(6, round(v/maxAttempts*100))`.

Priėmimo kriterijai

Žaidimas pagal taisykles (5x6), taisyklės matomos, klaidos LT, veikia ekrano ir fizinė klaviatūra, išsaugo būseną, testai praeina, UI responsyvus, spalvos turi alternatyvą neregintiems. Tikslinis žodis atsitiktinis naujam žaidimui; laikmatis taikomas tik Hard Mode.

UI animacijos ir UX sprendimai
------------------------------

- Klaviatūros paspaudimas: CSS ripple + subtilus scale (`.key-btn`).
- Statistikos modalas:
  - Atidarymas – overlay fade-in ir kortelės scale+slide in (CSS `modal-overlay`, `modal-card`).
  - Uždarymas – laikinai momentinis (be outro), kad išvengtume užstrigimų (overlay be kortelės). Outro sugrąžinsime valdant `animationend` vietoj `setTimeout`.
- Histogramos juostos: plotis auga per `transition`.
- Hard Mode mygtukas: subtilus pulsavimas (`.btn-pulse`).
- KPI skaitikliai: sklandus count-up su `requestAnimationFrame` ir ease-out.
- Apatinė juosta: sustiprintas `backdrop-blur-md` ir `shadow-lg` dėl vizualios hierarchijos.

A11y ir našumas
----------------

- Modalai su `aria-modal`, Escape uždarymu, fokusas nukreipiamas į „Uždaryti“.
- KPI skaitikliai turi `aria-live="polite"`.
- `prefers-reduced-motion`: sumažiname animacijų trukmę ir išjungiame nereikalingas perėjimo animacijas.
- Animacijos remiasi `transform/opacity` ir `will-change` (GPU-draugiška), vengiam layout thrash.

Pakeitimų istorija (trumpai)
----------------------------

- 2025-09-04: Išjungtas statistikos modalo uždarymo (outro) animavimas dėl stabilumo; paliktas tik atidarymo (intro) efektas. Z-index pakeltas overlay/kortelei.
- 2025-09-04: Patobulintos plytelių `flip-in`/`pop-in` animacijos (perspective, overshoot), pridėtas `prefers-reduced-motion`.
- 2025-09-04: Sustiprintas apatinės juostos `backdrop-blur` ir `shadow`.
- 2025-09-04: `StatsModal` gavo `animationDuration` prop; testuose naudojamas tiek `animationDuration={0}`, tiek RAF stub’as greitam užbaigimui.
- 2025-09-04: Testuose pridėtas stabilus `navigator.vibrate` stub’as; nutildytas React 19 perspėjimas „Expected static flag was missing“ setup’e.
- 2025-09-04: KPI grid’ui pridėtas `role="group" aria-label="KPI"`; mini kalendoriaus testas padarytas deterministinis naudojant `baseEpochDay()`.
- 2025-09-04: Coverage slenksčiai `vitest.config.ts` pakelti iki 100/100/100/100; pridėti testai, dengiantys likusias šakas (įsk. RAF `p<1` tęstinę šaką).
- 2025-09-04: Pakeista žodžio parinkimo strategija į atsitiktinę; per‑spėjimo laikmatis įjungiamas tik Hard Mode (UI/UX ir testų atnaujinimai).
- 2025-09-04: Pridėtas **leaderboard** funkcionalumas: vardo įvedimo modalas laimėjus (`WinNameModal`), lyderių lentelė statistikos modale su top 10 rezultatų, localStorage saugojimas su `saveLeaderboardEntry` ir `loadLeaderboard` funkcijomis. Testai papildyti leaderboard scenarijais.
- 2025-09-04: `StatsModal` histogramos pločio formulė supaprastinta, pašalinta nepasiekiama šaka; `AnimatedNumber` RAF planavimas paliktas su sąlyga `p<1` (išvengiant begalinio ciklo), padengta testais.